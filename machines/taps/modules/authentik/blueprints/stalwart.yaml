version: 1
metadata:
  name: Stalwart Mail OIDC Provider
  labels:
    blueprints.goauthentik.io/instantiate: "true"
context:
  stalwart_client_id: stalwart-mail
entries:
  - model: authentik_providers_oauth2.oauth2provider
    id: stalwart-provider
    identifiers:
      name: stalwart-mail
    attrs:
      name: stalwart-mail
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
      invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
      client_type: confidential
      client_id: !Context stalwart_client_id
      # Default value prevents blueprint discovery from failing if env var not yet loaded
      client_secret: !Env [STALWART_OIDC_CLIENT_SECRET, "placeholder-update-before-use"]
      redirect_uris:
        - matching_mode: strict
          url: https://mail.mulatta.io/oauth/callback
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
      sub_mode: hashed_user_id
      include_claims_in_id_token: true
      access_token_validity: hours=1
      refresh_token_validity: days=30
  - model: authentik_core.application
    id: stalwart-app
    identifiers:
      slug: stalwart-mail
    attrs:
      name: Stalwart Mail
      slug: stalwart-mail
      provider: !KeyOf stalwart-provider
      meta_launch_url: https://mail.mulatta.io
      meta_icon: https://stalw.art/img/logo.svg
      policy_engine_mode: any
